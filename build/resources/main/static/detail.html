<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë”ë³´ê¸° ì¡°íšŒ í˜ì´ì§€</title>
    <link rel="stylesheet" href="detail.css">
    <style>
        .rating-box .star {
            cursor: pointer;
            font-size: 2rem;
            transition: color 0.2s;
        }
        .comment-submit-btn {
            cursor: pointer;
        }
        .comment-star {
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.2s;
        }
        .main-address {
            font-size: 1.1rem;
            color: #333;
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        .main-address::before {
            content: 'ğŸ“';
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <button class="back-list-btn">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <div style="height: 40px;"></div>
    <main class="main-flex">
        <div class="main-left">
            <div class="main-image-box">
                <div id="detail-map" style="width:600px; height:400px; border-radius:8px; margin-bottom:10px;"></div>
                <div class="main-address"></div>
                <div class="main-building-info">
                    <span>ë©´ì : <b>2,500 sq ft</b></span><br>
                    <span>ì¸µìˆ˜: <b>3</b></span><br>
                    <span>ìš©ë„: <b>Commercial</b></span>
                </div>
            </div>
        </div>
        <div class="main-right">
            <div class="main-eq-info">
                <div class="main-eq-title">ì§€ì§„ ì •ë³´</div>
                <div class="main-eq-box">
                    <div class="main-eq-label">ì˜ˆì¸¡ ì§€ì§„ ê°•ë„</div>
                    <div class="main-eq-value">7.2</div>
                </div>
                <div class="main-eq-box">
                    <div class="main-eq-label">ë‚´ì§„ë“±ê¸‰</div>
                    <div class="main-eq-value">Special</div>
                </div>
                <div class="main-eq-box">
                    <div class="main-eq-label">ì£¼ëœ ë‚´ì§„ ì„¤ê³„ ë°©ì‹</div>
                    <div class="main-eq-value">Base Isolation</div>
                </div>
            </div>
        </div>
    </main>
    <section class="comment-section">
        <div class="comment-title">Comment</div>
        <div class="comment-input-box">
            <div class="comment-rating-box" style="display:inline-block; vertical-align:middle;">
                <span class="comment-star" data-value="1">&#9733;</span>
                <span class="comment-star" data-value="2">&#9733;</span>
                <span class="comment-star" data-value="3">&#9733;</span>
                <span class="comment-star" data-value="4">&#9733;</span>
                <span class="comment-star" data-value="5">&#9733;</span>
            </div>
            <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button class="comment-submit-btn" id="comment-submit-btn" disabled>ëŒ“ê¸€ ì‘ì„±</button>
        </div>
        <div id="comment-rating-avg" style="margin:8px 0; font-weight:bold;"></div>
        <div class="comment-list-box" id="comment-list-box">
            <!-- JSë¡œ ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ -->
        </div>
    </section>
    <script>
        // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelector('.back-list-btn').addEventListener('click', function() {
            // ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™
            window.location.href = 'main.html';
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIINgY-EVyXtgONcH9Gmsmbb7x8xvCddI&callback=initDetailMap"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const sharedResults = JSON.parse(localStorage.getItem('sharedResults') || '[]');
        const idx = localStorage.getItem('selectedResultIdx');
        
        // ê³µìœ ëœ ê²°ê³¼ë§Œ í•„í„°ë§
        const publicResults = sharedResults.filter(result => result.isShared);
        
        if (!publicResults[idx]) {
            console.error('ì„ íƒëœ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const result = publicResults[idx];

        // ì£¼ì†Œ í‘œì‹œ
        const address = result.address || '-';
        document.querySelector('.main-address').textContent = address;

        // ê±´ë¬¼ ì •ë³´ í‘œì‹œ
        document.querySelector('.main-building-info').innerHTML = `
            <span>ë©´ì : <b>${result.area || '-'}</b></span><br>
            <span>ì¸µìˆ˜: <b>${result.floors || '-'}</b></span><br>
            <span>ìš©ë„: <b>${result.usage || '-'}</b></span>
        `;

        // ì§€ì§„ ì •ë³´ í‘œì‹œ
        const eqBoxes = document.querySelectorAll('.main-eq-box');
        if (eqBoxes.length >= 3) {
            eqBoxes[0].querySelector('.main-eq-value').innerText = result.eqStrength || '-';
            eqBoxes[1].querySelector('.main-eq-value').innerText = result.eqGrade || '-';
            eqBoxes[2].querySelector('.main-eq-value').innerText = result.eqType || '-';
        }

        // ì§€ë„ í‘œì‹œ
        window.initDetailMap = function() {
            if (!address || address === '-') {
                console.error('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const geocoder = new google.maps.Geocoder();
            const map = new google.maps.Map(document.getElementById('detail-map'), {
                zoom: 15
            });
            const marker = new google.maps.Marker({ map: map });
            const infoWindow = new google.maps.InfoWindow();

            geocoder.geocode({address: address}, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    marker.setPosition(location);
                    infoWindow.setContent('<div style="padding:5px;font-size:12px;">' + address + '</div>');
                    infoWindow.open(map, marker);
                } else {
                    console.error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', status);
                }
            });
        }

        // ëŒ“ê¸€ ê¸°ëŠ¥
        const commentInput = document.getElementById('comment-input');
        const commentSubmitBtn = document.getElementById('comment-submit-btn');
        const commentListBox = document.getElementById('comment-list-box');
        result.commentsArr = result.commentsArr || [];
        
        // ëŒ“ê¸€ ë³„ì  ê¸°ëŠ¥
        let commentRating = 0;
        document.querySelectorAll('.comment-star').forEach(star => {
            star.addEventListener('mouseenter', function() {
                highlightCommentStars(Number(this.dataset.value));
            });
            star.addEventListener('mouseleave', function() {
                highlightCommentStars(commentRating);
            });
            star.addEventListener('click', function() {
                commentRating = Number(this.dataset.value);
                highlightCommentStars(commentRating);
                updateSubmitBtnState();
            });
        });

        function highlightCommentStars(rating) {
            document.querySelectorAll('.comment-star').forEach(star => {
                star.style.color = (Number(star.dataset.value) <= rating) ? '#FFD700' : '#ccc';
            });
        }

        function updateSubmitBtnState() {
            commentSubmitBtn.disabled = !(commentInput.value.trim() && commentRating > 0);
        }

        commentInput.addEventListener('input', updateSubmitBtnState);

        commentSubmitBtn.addEventListener('click', function() {
            const text = commentInput.value.trim();
            if (!text || commentRating === 0) return;

            const loginUser = localStorage.getItem('loginUser');
            if (!loginUser) {
                alert('ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            const comment = {
                text,
                rating: commentRating,
                author: loginUser,
                date: new Date().toLocaleString()
            };

            result.commentsArr.push(comment);
            sharedResults[idx] = result;
            localStorage.setItem('sharedResults', JSON.stringify(sharedResults));
            
            commentInput.value = '';
            commentRating = 0;
            highlightCommentStars(0);
            commentSubmitBtn.disabled = true;
            
            renderComments();
            renderCommentAvg();
        });

        function renderComments() {
            commentListBox.innerHTML = '';
            result.commentsArr.forEach(c => {
                const div = document.createElement('div');
                div.className = 'comment-list-header';
                div.innerHTML = `
                    <span>${c.text}</span>
                    <span class="comment-author">${c.author}</span>
                    <span class="comment-date">${c.date}</span>
                    <span class="comment-stars">${renderStars(c.rating)}</span>
                `;
                commentListBox.appendChild(div);
            });
        }

        function renderCommentAvg() {
            const avgDiv = document.getElementById('comment-rating-avg');
            if (!result.commentsArr.length) {
                avgDiv.innerText = '';
                return;
            }
            const avg = (result.commentsArr.reduce((sum, c) => sum + (c.rating || 0), 0) / result.commentsArr.length).toFixed(1);
            avgDiv.innerText = `ëŒ“ê¸€ ë³„ì  í‰ê· : ${avg}ì `;
        }

        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<span style="color:${i <= rating ? '#FFD700' : '#ccc'}; font-size:1.2rem;">&#9733;</span>`;
            }
            return html;
        }

        renderComments();
        renderCommentAvg();
    });
    </script>
</body>
</html>
