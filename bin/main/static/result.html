<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²°ê³¼ í™”ë©´</title>
    <link rel="stylesheet" href="result.css">
    <style>
        .result-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .image-and-building {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .image-section {
            flex: 1;
            min-width: 0; /* flex itemì´ ë¶€ëª¨ ì»¨í…Œì´ë„ˆë¥¼ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ì„¤ì • */
        }
        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .building-info {
            width: 300px;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .info-and-buttons {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .selected-address {
            font-size: 1.1rem;
            color: #333;
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        .selected-address::before {
            content: 'ğŸ“';
            margin-right: 8px;
        }
        @media (max-width: 768px) {
            .image-and-building {
                flex-direction: column;
            }
            .building-info {
                width: 100%;
            }
            #map {
                height: 300px;
            }
        }
    </style>
    <!-- PapaParse CDN ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <main class="result-container">
        <div class="image-and-building">
            <div class="image-section">
                <div id="map"></div>
                <div class="selected-address" id="selected-address-text"></div>
                <button class="edit-button">ìˆ˜ì •</button>
            </div>
            <div class="building-info">
                <div class="info-header">
                    <h3>ê±´ë¬¼ ì •ë³´</h3>
                    <button class="edit-button-small">ìˆ˜ì •</button>
                </div>
                <p>ë©´ì : <span id="building-area">-</span></p>
                <p>ì¸µìˆ˜: <span id="building-floors">-</span></p>
                <p>ìš©ë„: <span id="building-usage">-</span></p>
            </div>
        </div>
        <div class="info-and-buttons">
            <div class="info-section">
                <h2>ë‚´ì§„ ì„¤ê³„ ë¶„ì„ ê²°ê³¼</h2>
                <ul>
                    <li>ì˜ˆì¸¡ ì§€ì§„ ê°•ë„: <strong>7.0 ê·œëª¨</strong></li>
                    <li>ë‚´ì§„ë“±ê¸‰: <strong>íŠ¹ë“±ê¸‰</strong></li>
                    <li>ì¶”ì²œ ë‚´ì§„ ì„¤ê³„ ë°©ì‹: <strong>ë©´ì§„êµ¬ì¡°</strong></li>
                </ul>
            </div>
            <div class="button-group">
                <button class="save-button" id="open-save-popup">ê²°ê³¼ ì €ì¥í•˜ê¸°</button>
                <button class="share-button">ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
                <button class="back-button">ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </main>

    <!-- ê²°ê³¼ ì €ì¥ íŒì—…ì°½ -->
    <div class="save-popup" id="save-popup" style="display:none;">
        <div class="save-popup-inner">
            <div class="save-popup-header">
                <span>íŒŒì¼ ì €ì¥</span>
                <span class="save-popup-time" id="save-popup-time">17:03</span>
            </div>
            <div class="save-popup-content">
                <label for="save-title">ì œëª©</label>
                <input type="text" id="save-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="save-popup-actions">
                <button class="save-popup-save">ì €ì¥</button>
                <button class="save-popup-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
    document.getElementById('open-save-popup').onclick = function() {
        const loginUser = localStorage.getItem('loginUser');
        if (!loginUser) {
            alert('ê²°ê³¼ë¥¼ ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'index.html';
            return;
        }
        document.getElementById('save-popup').style.display = 'flex';
        // í˜„ì¬ ì‹œê°„ í‘œì‹œ
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('save-popup-time').innerText = `${hh}:${mm}`;
    };

    document.querySelector('.save-popup-cancel').onclick = function() {
        document.getElementById('save-popup').style.display = 'none';
    };

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.save-popup-save').onclick = function() {
        const title = document.getElementById('save-title').value.trim();
        if (!title) {
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const loginUser = localStorage.getItem('loginUser');
        const result = {
            id: Date.now(),
            userId: loginUser,
            title: title,
            address: localStorage.getItem('selectedAddress'),
            area: localStorage.getItem('buildingArea'),
            floors: localStorage.getItem('buildingFloors'),
            usage: localStorage.getItem('buildingUsage'),
            eqStrength: '7.0 ê·œëª¨',
            eqGrade: 'íŠ¹ë“±ê¸‰',
            eqType: 'ë©´ì§„êµ¬ì¡°',
            date: new Date().toISOString().slice(0,10),
            commentsArr: [],
            isShared: false
        };

        const sharedResults = JSON.parse(localStorage.getItem('sharedResults') || '[]');
        sharedResults.push(result);
        localStorage.setItem('sharedResults', JSON.stringify(sharedResults));
        
        document.getElementById('save-popup').style.display = 'none';
        document.getElementById('save-title').value = '';
        alert('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
    };

    // ë©”ì¸í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector('.back-button').addEventListener('click', function() {
        // ë©”ì¸í™”ë©´ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'main.html';
    });

    // ì´ë¯¸ì§€ ì„¹ì…˜ì˜ ìˆ˜ì • ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector('.image-section .edit-button').addEventListener('click', function() {
        // ìœ„ì¹˜ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'location.html';
    });

    // ê±´ë¬¼ì •ë³´ì˜ ìˆ˜ì • ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelector('.building-info .edit-button-small').addEventListener('click', function() {
        // ê±´ë¬¼ì •ë³´ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'building.html';
    });
    </script>

    <script>
    // ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // km
        var dLat = (lat2-lat1) * Math.PI/180;
        var dLon = (lon2-lon1) * Math.PI/180;
        var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c;
        return d;
    }

    // ì§€ë„ì— ê³¼ê±° ì§€ì§„ ë°ì´í„° ë§ˆì»¤ í‘œì‹œ
    function showEarthquakeMarkers(map, centerLat, centerLng) {
        Papa.parse('earthquakes.csv', {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data;
                data.forEach(eq => {
                    // í•œê¸€ ì»¬ëŸ¼ëª… ì‚¬ìš©
                    const lat = parseFloat(eq["ìœ„ë„"]);
                    const lng = parseFloat(eq["ê²½ë„"]);
                    const mag = eq["ê·œëª¨"];
                    const loc = eq["ìœ„ì¹˜"];
                    if (isNaN(lat) || isNaN(lng)) return; // ì˜ëª»ëœ ë°ì´í„° ê±´ë„ˆëœ€
                    // ë°˜ê²½ 400km ì´ë‚´ë§Œ í‘œì‹œ
                    if (getDistanceFromLatLonInKm(centerLat, centerLng, lat, lng) < 400) {
                        const marker = new google.maps.Marker({
                            position: {lat, lng},
                            map: map,
                            icon: {
                                url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png', // íŒŒë€ìƒ‰ ë§ˆì»¤
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `ê·œëª¨: ${mag}<br>ìœ„ì¹˜: ${loc}<br>ë‚ ì§œ: ${eq["ì‹œê°„"]}`
                        });
                        marker.addListener('click', function() {
                            infoWindow.open(map, marker);
                        });
                        // ë””ë²„ê¹…ìš© ë¡œê·¸
                        console.log('ë§ˆì»¤ ì¶”ê°€:', lat, lng, mag, loc);
                    }
                });
            }
        });
    }
    </script>

    <script>
    // êµ¬ê¸€ ì§€ë„ì— ìœ„ì¹˜ì„ íƒì—ì„œ ì €ì¥í•œ ì£¼ì†Œë¥¼ í‘œì‹œ
    function initResultMap() {
        const address = localStorage.getItem('selectedAddress');
        if (!address) {
            alert('ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            window.location.href = 'location.html';
            return;
        }

        // ì„ íƒí•œ ì£¼ì†Œ í…ìŠ¤íŠ¸ í‘œì‹œ
        document.getElementById('selected-address-text').textContent = address;

        const geocoder = new google.maps.Geocoder();
        const map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 37.566826, lng: 126.978656},
            zoom: 13
        });
        const marker = new google.maps.Marker({ map: map });
        const infoWindow = new google.maps.InfoWindow();

        geocoder.geocode({address: address}, function(results, status) {
            if (status === 'OK') {
                map.setCenter(results[0].geometry.location);
                marker.setPosition(results[0].geometry.location);
                infoWindow.setContent('<div style="padding:5px;font-size:12px;">' + address + '</div>');
                infoWindow.open(map, marker);
                // ì¤‘ì‹¬ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ì§€ì§„ ë§ˆì»¤ í‘œì‹œ
                showEarthquakeMarkers(map, results[0].geometry.location.lat(), results[0].geometry.location.lng());
            } else {
                alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + status);
            }
        });
    }
    window.initResultMap = initResultMap;
    </script>

    <script>
    // ê±´ë¬¼ ì •ë³´ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', function() {
        const area = localStorage.getItem('buildingArea') || '-';
        const floors = localStorage.getItem('buildingFloors') || '-';
        const usage = localStorage.getItem('buildingUsage') || '-';
        document.getElementById('building-area').innerText = area;
        document.getElementById('building-floors').innerText = floors;
        document.getElementById('building-usage').innerText = usage;
        // ì¶”ê°€: buildingInfoë¡œ ë“±ê¸‰/ë°©ì‹ í‘œì‹œ
        const buildingInfo = JSON.parse(localStorage.getItem('buildingInfo') || '{}');
        if (buildingInfo && buildingInfo.usage) {
            document.querySelector('.info-section ul li:nth-child(2) strong').innerText = getSeismicGrade(buildingInfo);
            document.querySelector('.info-section ul li:nth-child(3) strong').innerText = getSeismicMethod(buildingInfo);
        }
    });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIINgY-EVyXtgONcH9Gmsmbb7x8xvCddI&callback=initResultMap"></script>

    <script>
    document.querySelector('.share-button').addEventListener('click', function() {
        const loginUser = localStorage.getItem('loginUser');
        if (!loginUser) {
            alert('ê²°ê³¼ë¥¼ ê³µìœ í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'index.html';
            return;
        }

        // buildingInfoì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì¶”ê°€)
        const buildingInfo = JSON.parse(localStorage.getItem('buildingInfo') || '{}');

        const result = {
            id: Date.now(),
            userId: loginUser,
            title: prompt('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'ê²€ìƒ‰ ê¸°ë¡'),
            address: localStorage.getItem('selectedAddress'),
            area: buildingInfo.area || localStorage.getItem('buildingArea'),
            floors: buildingInfo.floors || localStorage.getItem('buildingFloors'),
            usage: buildingInfo.usage || localStorage.getItem('buildingUsage'),
            eqStrength: '7.0 ê·œëª¨',
            eqGrade: 'íŠ¹ë“±ê¸‰',
            eqType: 'ë©´ì§„êµ¬ì¡°',
            date: new Date().toISOString().slice(0,10),
            commentsArr: [],
            isShared: true
        };
        const sharedResults = JSON.parse(localStorage.getItem('sharedResults') || '[]');
        sharedResults.push(result);
        localStorage.setItem('sharedResults', JSON.stringify(sharedResults));
        alert('ê³µìœ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸í™”ë©´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
    });
    </script>

    <script>
    // ë‚´ì§„ë“±ê¸‰/ì„¤ê³„ë°©ì‹ íŒì • í•¨ìˆ˜ (í‘œ ê¸°ì¤€)
    function getSeismicGrade(info) {
        if (info.usage === 'ì¢…í•©ë³‘ì›/ìˆ˜ìˆ Â·ì‘ê¸‰ì‹œì„¤ ìˆëŠ” ë³‘ì›') return 'íŠ¹ë“±ê¸‰';
        if (info.usage === 'ê¸´ê¸‰ëŒ€í”¼ìˆ˜ìš©ì‹œì„¤') return 'íŠ¹ë“±ê¸‰';
        if (info.usage === 'ìœ„í˜‘ë¬¼ ì €ì¥ ë° ì²˜ë¦¬ì‹œì„¤') return 'íŠ¹ë“±ê¸‰';
        if (info.usage === 'ì²­ì™€ëŒ€/ë°œì „ì†Œ/ë°©ì†¡êµ­ ë“± êµ­ê°€Â·ì§€ìì²´ ì£¼ìš”ì‹œì„¤') return 'íŠ¹ë“±ê¸‰';
        if (info.area === '1,000ã¡ ì´ìƒ') return '1ë“±ê¸‰';
        if (info.usage === 'ê³µì—°ì¥/ì§‘íšŒì¥/ê´€ëŒì¥/ì „ì‹œì¥/ìš´ë™ì‹œì„¤/íŒë§¤ì‹œì„¤' && info.area === '5,000ã¡ ì´ìƒ') return '1ë“±ê¸‰';
        if (info.area === '1,000ã¡ ë¯¸ë§Œ') return '2ë“±ê¸‰';
        if (info.usage === 'ì•„ë…¸ì‚¬ê±´(ì•„ë™Â·ë…¸ì¸Â·ì‚¬íšŒë³µì§€ì‹œì„¤ ë“±)') return '2ë“±ê¸‰';
        if (info.usage === 'ìˆ™ë°•ì‹œì„¤(ì˜¤í”¼ìŠ¤í…”Â·ê¸°ìˆ™ì‚¬Â·ì•„íŒŒíŠ¸ ë“±)' && ['1ì¸µ','2ì¸µ','3ì¸µ','4ì¸µ','5ì¸µ ì´ìƒ'].includes(info.floors)) return '2ë“±ê¸‰';
        if (info.usage === 'í•™êµ') return '2ë“±ê¸‰';
        if (info.usage === 'ë³‘ì›' && info.area === '1,000ã¡ ë¯¸ë§Œ') return '2ë“±ê¸‰';
        if (info.usage === 'ì‚¬ë¬´ì‹¤') return '3ë“±ê¸‰';
        if (info.usage === 'ë†ì—…ì‹œì„¤') return '3ë“±ê¸‰';
        if (info.usage === 'ê°€ì„¤êµ¬ì¡°ë¬¼') return '3ë“±ê¸‰';
        if (info.usage === 'ê¸°íƒ€') return '3ë“±ê¸‰';
        return '2ë“±ê¸‰';
    }
    function getSeismicMethod(info) {
        if (info.usage.includes('ë³‘ì›') || info.usage === 'ê¸´ê¸‰ëŒ€í”¼ìˆ˜ìš©ì‹œì„¤') return 'ë©´ì§„êµ¬ì¡°';
        if (info.floors === '5ì¸µ ì´ìƒ' || info.area === '5,000ã¡ ì´ìƒ') return 'ì œì§„êµ¬ì¡°';
        return 'ë‚´ì§„êµ¬ì¡°';
    }
    </script>

    <script>
    // ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜ ìˆ˜ì •
    function addComment(resultId, comment) {
        const sharedResults = JSON.parse(localStorage.getItem('sharedResults') || '[]');
        const resultIndex = sharedResults.findIndex(r => r.id === resultId);
        
        if (resultIndex !== -1) {
            const loginUser = localStorage.getItem('loginUser');
            const newComment = {
                userId: loginUser,
                comment: comment,
                date: new Date().toISOString().slice(0,10)
            };
            
            sharedResults[resultIndex].commentsArr.push(newComment);
            localStorage.setItem('sharedResults', JSON.stringify(sharedResults));
            
            // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
            displayComments(resultId);
            return true;
        }
        return false;
    }

    // ëŒ“ê¸€ í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
    function displayComments(resultId) {
        const sharedResults = JSON.parse(localStorage.getItem('sharedResults') || '[]');
        const result = sharedResults.find(r => r.id === resultId);
        
        if (result) {
            const commentsContainer = document.querySelector('.comments-container');
            if (commentsContainer) {
                commentsContainer.innerHTML = '';
                result.commentsArr.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-user">${comment.userId}</span>
                            <span class="comment-date">${comment.date}</span>
                        </div>
                        <div class="comment-content">${comment.comment}</div>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            }
        }
    }
    </script>
</body>
</html>
